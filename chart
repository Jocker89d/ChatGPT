---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: forecasting-revenue
  namespace: spark
  labels:
    app: forecasting-revenue
spec:
  replicas: 1
  selector:
    matchLabels:
      app: forecasting-revenue
  template:
    metadata:
      labels:
        app: forecasting-revenue
    spec:
      hostNetwork: true
      containers:
        - name: forecasting-revenue
          image: acuityads/aa-data-forecasting:3.1.2-1.48.0R-1.0.16
          imagePullPolicy: Always
          resources:
            requests:
              cpu: "1"
              memory: "2Gi"
            limits:
              cpu: "1"
              memory: "2Gi"
          env:
            - name: SPARK_YARN_QUEUE
              value: default
            - name: APP_NAME
              value: "QA6 Forecasting Revenue"
            - name: DRIVER_CLASS_NAME
              value: RevenueForecastingDriver
            - name: SOURCE_KAFKA_TOPIC
              value: REVENUEEVENT
            - name: SPARK_DRIVER_MEMORY
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_MEM_2G
            - name: SPARK_DRIVER_MEMORY_OVERHEAD
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_MEM_1G
            - name: SPARK_DRIVER_JVM_OPTIONS
              value: "-Duser.timezone=UTC -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:+UseG1GC"
            - name: SPARK_NUM_EXECUTORS
              value: "1"
            - name: SPARK_EXECUTOR_MEMORY
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_MEM_2G
            - name: SPARK_EXECUTOR_MEMORY_OVERHEAD
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_MEM_1G
            - name: SPARK_EXECUTOR_CORES
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_CORES_1
            - name: SPARK_EXECUTOR_JVM_OPTIONS
              value: "-Duser.timezone=UTC -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:+UseG1GC"
            - name: MAX_PER_TRIGGER
              value: '10000000'
            - name: HEARTBEAT_USER
              valueFrom:
                secretKeyRef:
                  name: prod-passwords
                  key: HEARTBEAT_USER
            - name: HEARTBEAT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: prod-passwords
                  key: HEARTBEAT_PASSWORD
            - name: SOURCE_KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: cluster-env
                  key: KAFKA_REVENUE_BOOTSTRAP
            - name: SINK_KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: cluster-env
                  key: KAFKA_MAIN_BOOTSTRAP
            - name: FORECASTING_TOPIC
              value: DRUID_FORECASTING
            - name: CHECKPOINT_PATH
              value: /checkpoint/forecasting-revenue
            - name: KAFKA_INIT_OFFSET
              value: earliest
            - name: TRIGGER_INTERVAL
              value: "10 minutes"
            - name: MYSQL_SLAVE_USER
              value: acuity
            - name: MYSQL_SLAVE_PASSWORD
              value: acuity2018
            - name: KAFKA_METRIC_TOPIC
              valueFrom:
                configMapKeyRef:
                  name: cluster-env
                  key: KAFKA_METRIC_TOPIC
            - name: KAFKA_METRIC_BOOTSTRAP
              valueFrom:
                configMapKeyRef:
                  name: cluster-env
                  key: KAFKA_METRIC_BOOTSTRAP
            - name: KAFKA_METRIC_KEY
              value: forecasting-revenue
            - name: INVENTORY_SERVICE
              value: http://10.64.77.147:8080
            - name: AEROPSIKE_SPRING_CONTEXT
              value: aerospike-qa6.xml
            - name: SPARK_FILES
              value: /opt/app-conf/aerospike-qa6.xml,/opt/app-conf/aerospike-qa6.properties,/opt/GeoIP2-ISP.mmdb
            - name: MAXMIND_ISP_DB_FILE_LOCATION
              value: GeoIP2-ISP.mmdb
          envFrom:
            - configMapRef:
                name: cluster-env
          volumeMounts:
            - mountPath: /opt/cluster-conf
              name: cluster-configs-volume
            - name: aerospike-configs-volume
              mountPath: /opt/app-conf/aerospike-qa6.xml
              subPath: aerospike-qa6.xml
            - name: aerospike-configs-volume
              mountPath: /opt/app-conf/aerospike-qa6.properties
              subPath: aerospike-qa6.properties
      volumes:
        - name: cluster-configs-volume
          configMap:
            name: cluster-conf
        - name: aerospike-configs-volume
          configMap:
            name: forecasting-aerospike-configs
      nodeSelector:
        node-role.kubernetes.io/worker: hadoop
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: forecasting-response
  namespace: spark
  labels:
    app: forecasting-response
spec:
  replicas: 1
  selector:
    matchLabels:
      app: forecasting-response
  template:
    metadata:
      labels:
        app: forecasting-response
    spec:
      hostNetwork: true
      containers:
        - name: forecasting-response
          image: acuityads/aa-data-forecasting:3.1.2-1.48.0R-1.0.16
          imagePullPolicy: Always
          resources:
            requests:
              cpu: "1"
              memory: "2Gi"
            limits:
              cpu: "1"
              memory: "2Gi"
          env:
            - name: SPARK_YARN_QUEUE
              value: default
            - name: APP_NAME
              value: "QA6 Forecasting Response"
            - name: DRIVER_CLASS_NAME
              value: BidResponseForecastingDriver
            - name: SOURCE_KAFKA_TOPIC
              value: BIDRESPONSE
            - name: SOURCE_KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: cluster-env
                  key: KAFKA_MAIN_BOOTSTRAP
            - name: SINK_KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: cluster-env
                  key: KAFKA_MAIN_BOOTSTRAP
            - name: SPARK_DRIVER_MEMORY
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_MEM_4G
            - name: SPARK_DRIVER_MEMORY_OVERHEAD
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_MEM_1G
            - name: SPARK_DRIVER_JVM_OPTIONS
              value: "-Duser.timezone=UTC -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:+UseG1GC"
            - name: SPARK_NUM_EXECUTORS
              value: "1"
            - name: SPARK_EXECUTOR_MEMORY
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_MEM_4G
            - name: SPARK_EXECUTOR_MEMORY_OVERHEAD
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_MEM_1G
            - name: SPARK_EXECUTOR_CORES
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_CORES_1
            - name: SPARK_EXECUTOR_JVM_OPTIONS
              value: "-Duser.timezone=UTC -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:+UseG1GC"
            - name: MAX_PER_TRIGGER
              value: '50000000'
            - name: SPARK_NUM_PARTITIONS
              value: '200'
            - name: HEARTBEAT_USER
              valueFrom:
                secretKeyRef:
                  name: prod-passwords
                  key: HEARTBEAT_USER
            - name: HEARTBEAT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: prod-passwords
                  key: HEARTBEAT_PASSWORD
            - name: FORECASTING_TOPIC
              value: DRUID_FORECASTING
            - name: CHECKPOINT_PATH
              value: /checkpoint/forecasting-response
            - name: TRIGGER_INTERVAL
              value: 5 minutes
            - name: KAFKA_INIT_OFFSET
              value: earliest
            - name: MYSQL_SLAVE_USER
              value: acuity
            - name: MYSQL_SLAVE_PASSWORD
              value: acuity2018
            - name: MYSQL_SLAVE_OPTION
              value: ?serverTimezone=UTC&autoReconnect=true&sessionVariables=transaction_isolation='READ-COMMITTED'
            - name: KAFKA_METRIC_TOPIC
              valueFrom:
                configMapKeyRef:
                  name: cluster-env
                  key: KAFKA_METRIC_TOPIC
            - name: KAFKA_METRIC_BOOTSTRAP
              valueFrom:
                configMapKeyRef:
                  name: cluster-env
                  key: KAFKA_METRIC_BOOTSTRAP
            - name: KAFKA_METRIC_KEY
              value: forecasting-response
            - name: INVENTORY_SERVICE
              value: http://10.64.77.147:8080
            - name: AEROPSIKE_SPRING_CONTEXT
              value: aerospike-qa6.xml
            - name: SPARK_FILES
              value: /opt/app-conf/aerospike-qa6.xml,/opt/app-conf/aerospike-qa6.properties,/opt/GeoIP2-ISP.mmdb
            - name: MAXMIND_ISP_DB_FILE_LOCATION
              value: GeoIP2-ISP.mmdb
          envFrom:
            - configMapRef:
                name: cluster-env
          volumeMounts:
            - mountPath: /opt/cluster-conf
              name: cluster-configs-volume
            - name: aerospike-configs-volume
              mountPath: /opt/app-conf/aerospike-qa6.xml
              subPath: aerospike-qa6.xml
            - name: aerospike-configs-volume
              mountPath: /opt/app-conf/aerospike-qa6.properties
              subPath: aerospike-qa6.properties
      volumes:
        - name: cluster-configs-volume
          configMap:
            name: cluster-conf
        - name: aerospike-configs-volume
          configMap:
            name: forecasting-aerospike-configs
      nodeSelector:
        node-role.kubernetes.io/worker: hadoop
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: forecasting-request
  namespace: spark
  labels:
    app: forecasting-request
spec:
  replicas: 1
  selector:
    matchLabels:
      app: forecasting-request
  template:
    metadata:
      labels:
        app: forecasting-request
    spec:
      hostNetwork: true
      containers:
        - name: forecasting-request
          image: acuityads/aa-data-forecasting:3.1.2-1.48.0R-1.0.16
          imagePullPolicy: Always
          resources:
            requests:
              cpu: "1"
              memory: "2Gi"
            limits:
              cpu: "1"
              memory: "2Gi"
          env:
            - name: APP_NAME
              value: "QA6 Forecasting Request"
            - name: SPARK_YARN_QUEUE
              value: default
            - name: DRIVER_CLASS_NAME
              value: BidRequestForecastingDriver
            - name: SOURCE_KAFKA_TOPIC
              value: BIDROUTERREQUEST
            - name: SPARK_DRIVER_MEMORY
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_MEM_2G
            - name: SPARK_DRIVER_MEMORY_OVERHEAD
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_MEM_1G
            - name: SPARK_DRIVER_JVM_OPTIONS
              value: "-Duser.timezone=UTC -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:+UseG1GC"
            - name: SPARK_NUM_EXECUTORS
              value: "1"
            - name: SPARK_EXECUTOR_MEMORY
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_MEM_8G
            - name: SPARK_EXECUTOR_MEMORY_OVERHEAD
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_MEM_1G
            - name: SPARK_EXECUTOR_CORES
              valueFrom:
                configMapKeyRef:
                  name: app-configs
                  key: EXECUTOR_CORES_1
            - name: SPARK_EXECUTOR_JVM_OPTIONS
              value: "-Duser.timezone=UTC -XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:+UseG1GC"
            - name: MAX_PER_TRIGGER
              value: "100000000"
            - name: SPARK_NUM_PARTITIONS
              value: '200'
            - name: HEARTBEAT_USER
              valueFrom:
                secretKeyRef:
                  name: prod-passwords
                  key: HEARTBEAT_USER
            - name: HEARTBEAT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: prod-passwords
                  key: HEARTBEAT_PASSWORD
            - name: SOURCE_KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: cluster-env
                  key: KAFKA_MAIN_BOOTSTRAP
            - name: SINK_KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: cluster-env
                  key: KAFKA_MAIN_BOOTSTRAP
            - name: FORECASTING_TOPIC
              value: DRUID_FORECASTING
            - name: CHECKPOINT_PATH
              value: /checkpoint/forecasting-request-bdr
            - name: KAFKA_INIT_OFFSET
              value: earliest
            - name: TRIGGER_INTERVAL
              value: "5 minutes"
            - name: MYSQL_SLAVE_USER
              value: acuity
            - name: MYSQL_SLAVE_PASSWORD
              value: acuity2018
            - name: MYSQL_SLAVE_OPTION
              value: ?serverTimezone=UTC&autoReconnect=true&sessionVariables=transaction_isolation='READ-COMMITTED'
            - name: KAFKA_METRIC_TOPIC
              valueFrom:
                configMapKeyRef:
                  name: cluster-env
                  key: KAFKA_METRIC_TOPIC
            - name: KAFKA_METRIC_BOOTSTRAP
              valueFrom:
                configMapKeyRef:
                  name: cluster-env
                  key: KAFKA_METRIC_BOOTSTRAP
            - name: KAFKA_METRIC_KEY
              value: forecasting-request
            - name: INVENTORY_SERVICE
              value: http://10.64.77.147:8080
            - name: AEROPSIKE_SPRING_CONTEXT
              value: aerospike-qa6.xml
            - name: SPARK_FILES
              value: /opt/app-conf/aerospike-qa6.xml,/opt/app-conf/aerospike-qa6.properties,/opt/GeoIP2-ISP.mmdb
            - name: MAXMIND_ISP_DB_FILE_LOCATION
              value: GeoIP2-ISP.mmdb
          envFrom:
            - configMapRef:
                name: cluster-env
          volumeMounts:
            - mountPath: /opt/cluster-conf
              name: cluster-configs-volume
            - name: aerospike-configs-volume
              mountPath: /opt/app-conf/aerospike-qa6.xml
              subPath: aerospike-qa6.xml
            - name: aerospike-configs-volume
              mountPath: /opt/app-conf/aerospike-qa6.properties
              subPath: aerospike-qa6.properties
      volumes:
        - name: cluster-configs-volume
          configMap:
            name: cluster-conf
        - name: aerospike-configs-volume
          configMap:
            name: forecasting-aerospike-configs
      nodeSelector:
        node-role.kubernetes.io/worker: hadoop
apiVersion: v1
kind: ConfigMap
metadata:
  name: forecasting-aerospike-configs
  namespace: spark
data:
  aerospike-qa6.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <beans xmlns="http://www.springframework.org/schema/beans"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:jee="http://www.springframework.org/schema/jee"
           xsi:schemaLocation="http://www.springframework.org/schema/beans
                              http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee.xsd">

        <import resource="aerospike.xml"/>

        <bean id="configurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
            <property name="locations">
                <list>
                    <value>aerospike-qa6.properties</value>
                </list>
            </property>
        </bean>

    </beans>
  aerospike-qa6.properties: |
    metric.kafka.brokers=qa6-kf-1.acuityads.org:9092,qa6-kf-2.acuityads.org:9092,qa6-kf-3.acuityads.org:9092
    metric.kafka.topic=METRIC
    metric.kafka.key=metrics

    AEROSPIKE_CLASSIFIER_PAGE_EXPIRATION=1209600
    AEROSPIKE_CLASSIFIER_PAGE_HOST_NAME=qa6-aerospike-1.acuityads.org
    AEROSPIKE_CLASSIFIER_PAGE_NAMESPACE=ssd-rf2-1
    AEROSPIKE_CLASSIFIER_PAGE_PORT_NUMBER=3000
    AEROSPIKE_CLASSIFIER_PAGE_READ_TIMEOUT_IN_MILLIS=1000
    AEROSPIKE_CLASSIFIER_PAGE_WRITE_TIMEOUT_IN_MILLIS=1000
    AEROSPIKE_METRIC_LOGGING_ON=true

    AEROSPIKE_CLASSIFIER_APP_EXPIRATION=1209600
    AEROSPIKE_CLASSIFIER_APP_HOST_NAME=qa6-aerospike-1.acuityads.org
    AEROSPIKE_CLASSIFIER_APP_NAMESPACE=ssd-rf2-1
    AEROSPIKE_CLASSIFIER_APP_PORT_NUMBER=3000
    AEROSPIKE_CLASSIFIER_APP_READ_TIMEOUT_IN_MILLIS=1000
    AEROSPIKE_CLASSIFIER_APP_WRITE_TIMEOUT_IN_MILLIS=1000

    AEROSPIKE_USER_DEMOGRAPHIC_EXPIRATION=5184000
    AEROSPIKE_USER_DEMOGRAPHIC_HOST=qa6-aerospike-2.acuityads.org
    AEROSPIKE_USER_DEMOGRAPHIC_NAMESPACE=ssd-rf2-8
    AEROSPIKE_USER_DEMOGRAPHIC_SET=UserDemographic
    AEROSPIKE_USER_DEMOGRAPHIC_PORT=3000
    AEROSPIKE_USER_DEMOGRAPHIC_READ_TIMEOUT_IN_MILLIS=1000
    AEROSPIKE_USER_DEMOGRAPHIC_WRITE_TIMEOUT_IN_MILLIS=1000
